# Шардирование
## Оглавление
- [Описание](#описание)
- [Виды шардирования](#виды-шардирования)
- [Способы шардирования](#способы-шардирования)
- [Преимущества шардирования](#преимущества-шардирования)
- [Недостатки шардирования](#недостатки-шардирования)
- [Методы шардинга](#методы-шардинга)
- [Применение шардирования в различных областях](#применение-шардирования-в-различных-областях)
## Описание
Шардирование или шардинг — это принцип проектирования базы данных, при котором данные разбиваются на части и 
размещаются на разных шардах. Каждый шард представляет собой отдельный узел внутри кластера, который может состоять 
из одной или нескольких реплик. Реплики — это серверы, на которых дублируются данные в рамках шарда.

Шардирование используется, если система требует все больше ресурсов, но вертикальное масштабирование кластера не может
быть использовано из-за физических пределов.

Популярные приложения и сайты рано или поздно должны масштабироваться, чтобы ускорить доступ к данным и увеличить 
трафик. Например, соцсеть набрала миллионы пользователей, и одного сервера ей уже недостаточно. Чтобы распределить 
данные на несколько серверов и обеспечить им безопасность и целостность, нужна база данных с соответствующей 
архитектурой — шардированная база данных.
## Виды шардирования
Выделяют 2 вида шардирования: 
- Вертикальное:

Такое шардирование предполагает разделение данных по столбцам. В этом случае каждый шард содержит часть столбцов 
массива и все связанные с ними строки данных. Вертикальное шардирование может быть полезно, когда некоторые столбцы 
используются чаще, а другие — реже. Это вид шардирования может использоваться в пределах одного сервера
путем обновления оборудования.

Например, у интернет-магазина накопился большой массив данных о товарах и покупателях. Чтобы увеличить 
производительность, можно разделить его на два шарда, один из которых вмещает записи о клиентах, а другой — о товарах. 
При выполнении запросов будут загружаться только необходимые столбцы.

Исходная таблица:

| ID клиента | Имя  | Фамилия | Город  |
|------------|------|---------|--------|
| 1          | Иван | Иванов  | Москва |

VS1:

| ID клиента | Имя  | Фамилия  |
|------------|------|----------|
| 1          | Иван | Иванов   |

VS2: 

| ID клиента | Город  |
|------------|--------|
| 1          | Москва |
- Горизонтальное: 

Этот вид подразумевает разделение хранилища на сгруппированные по каким-либо критериям строки. В этом случае каждый 
шард содержит одинаковые столбцы, но разные строки данных. Горизонтальное шардирование позволяет распределить
нагрузку на запись и чтение данных между различными серверами, за каждый из которых отвечает отдельная машина.

Например, социальная сеть содержит базу данных пользователей. Чтобы ослабить нагрузку на сервер, разработчики 
горизонтально делят ее по шардам, используя хеш-функцию для определения, в какой шард отправить каждую запись. 
В результате пользователи будут равномерно распределены по серверам.

Исходная таблица:

| ID клиента | Имя  | Фамилия | Город  |
|------------|------|---------|--------|
| 1          | Иван | Иванов  | Москва |
| 2          | Пётр | Петров  | Тула   |

HS1: 

| ID клиента | Имя  | Фамилия | Город  |
|------------|------|---------|--------|
| 1          | Иван | Иванов  | Москва |

HS2: 

| ID клиента | Имя  | Фамилия | Город  |
|------------|------|---------|--------|
| 2          | Пётр | Петров  | Тула   |
## Способы шардирования
Осуществить шардирование можно несколькими способами:
1) Средствами БД. Некоторые базы — MongoDB, Elasticsearch, ClickHouse и другие — умеют самостоятельно распределять 
данные между своими экземплярами, для этого достаточно настроить конфигурацию. 
2) Надстройками к БД. Самый спорный способ — применение надстроек, которые выполняют шардирование, например
Vitess или Citus, поскольку при этом есть риск потери данных и производительности.
3) Клиентскими средствами. В этом случае экземпляры БД даже не подозревают о существовании друг друга,
шардированием управляет стороннее приложение — со всеми вытекающими рисками.

Методы работы в этих способах схожи: мы выбираем ключ для распределения данных (это может быть идентификатор,
временная метка или хеш записи) и в соответствии с ним записываем информацию в нужный шард. Как правило, ключи
стараются выбирать так, чтобы данные были равномерно распределены по шардам. Сделать это не сложно — достаточно 
ориентироваться на текущее содержимое БД.

Важно учитывать для чего вы делаете шардирование. В случае если требуется распределить нагрузку на запись, необходимо
подобрать такой ключ, который обеспечит равномерное распределение запросов между инстансами. Нельзя забывать и
о «горячих» данных, запросы к которым происходят чаще, из-за чего нагрузка на шарды оказывается неравномерной.
Для этого можно добавить в приложение метрику, показывающую, сколько раз в какой шард будут попадать данные 
по конкретному ключу.
## Преимущества шардирования
Если база данных разрослась так сильно, что ее нельзя отмасштабировать, просто повысив вычислительные мощности, то на 
помощь приходит шардирование. Какие проблемы можно решить:
1) Преодолеть технические ограничения. Набирающие популярность продукты в итоге сталкиваются с потолком возможностей 
оборудования, и данные могут быть разделены по разным машинам, чтобы обеспечить возможность роста.
2) Повысить надежность. Если шарды базы данных физически находятся на разных серверах, то отказ одного из них не 
означает прекращение работы остальных. То есть вместо полного прекращения доступа к сайту или приложению может 
перестать работать лишь какая-то его часть.
3) Ускорить доступ к данным. Продукты с большой монолитной базой данных обычно не отличаются производительностью, 
так как запросы к ним конкурируют друг с другом. Шардирование помогает распределить нагрузку, увеличить объемы и 
скорость обработки данных.
## Недостатки шардирования
Хотя без шардирования иногда никак не обойтись, у такой архитектуры базы данных есть и существенные недостатки, 
из-за которых в некоторых случаях использовать его не рекомендуется. Основные из них включают:
1) Сложность реализации. Ошибки при шардировании могут стоить части данных или привести к повреждению хранилища. 
Также при разделении возникает риск того, что команда разработчиков будет работать менее эффективно. Вместо единой 
точки входа им придется управлять данными из нескольких сегментов.
2) Несбалансированность данных. Иногда бывает трудно предугадать, как будут накапливаться данные, и какой-то сервер 
может оказаться более загруженным, чем остальные. Например, какая-то часть пользователей соцсети стала гораздо 
популярнее всех остальных, а связанные с ними данные концентрируются на одном сервере. Для решения приходится 
прибегать к повторному сегментированию, но это приводит к простою серверов.
3) Потеря производительности при сложных запросах. Запрос одновременно к нескольким шардам будет иметь повышенную 
задержку. Для получения данных нужно будет обратиться к нескольким сегментам одновременно, что гораздо медленнее, 
чем получить данные из одной таблицы.
## Методы шардинга
Существует несколько основных методов шардирования данных. Поскольку все они имеют свои особенности, выбор конкретного
зависит от требований продукта. Рассмотрим самые распространенные:
- Хешированное — данные разбиваются на шарды на основе хеш-функции, которая принимает входные данные и возвращает 
хеш-значение. Это значение определяет, в какой шард будет помещена каждая запись данных. Метод позволяет достичь 
высокой производительности и отсутствия единой точки отказа, однако усложняет поиск данных. 
- Диапазонное — данные разбиваются на шарды на основе диапазона значений. Значения могут присваиваться с помощью ключей
(ключевое шардирование) и других атрибутов. Метод прост в реализации и позволяет быстрее находить информацию, чем при
хешировании, однако может привести к несбалансированности базы.
- Круговое — шарды упорядочиваются в виде кольца и каждый из них ответственен за определенный диапазон значений.
Запросы на данные маршрутизируются в соответствии с позицией шарда в кольце. Запросы распределяются равномерно, но
при добавлении и удалении шардов требуется перераспределение данных.
- Динамическое — позволяет автоматически масштабировать хранилище в зависимости от текущей производительности и
объема данных. Высокая гибкость такого хранилища требует надежную систему мониторинга и балансировки нагрузки,
а также хорошо продуманную архитектуру базы данных.
## Применение шардирования в различных областях
Необходимость шардинга возникает во всех сферах, где используются большие объемы данных. Будь то интернет-магазин,
стриминговый сервис или социальная сеть.
1) Шардирование разных баз данных. В некоторых базах предусмотрено автоматическое шардирование — в основном это 
NoSQL-системы вроде MongoDB и Apache Cassandra. Если такой функции не предусмотрено, 
то можно организовать шардирование вручную. Например:
   - Логистическая компания AliExpress Order Management System использует базу данных PostgreSQL, в которой нет 
   встроенных функций шардинга. Команда разработчиков вручную организовала масштабирование, распределив товары по
   шардам на основе их хеш-функций. 
   - Социальная сеть Twitter использует базу данных со встроенным шардированием — Apache Cassandra. С помощью
   масштабирования серверы оперативно справляются с огромным объемом текстовых и медиа-сообщений.
2) Шардирование веб-приложений. Приложения с большим количеством пользователей и трафика также распределяют нагрузку
между серверами. Например, онлайн-платформа для потокового воспроизведения видео Netflix разработала стратегию
шардирования данных в поисковой системе Elasticsearch, которая обеспечила ей низкую задержку поиска. Компания также 
использует шардированные базы данных Apache Kafka, Apache Cassandra, Zookeeper, EvCache и другие.
3) Шардирование в аналитике данных. Шардинг также может помочь в ускорении аналитических операций, позволяя проводить 
их равномерно на нескольких серверах. Например:
    - Сервис аналитики Look for sale с помощью шардирования анализирует данные по миллионам артикулов товаров,
   помогая бизнесу принимать стратегические решения. 
    - LinkedIn обрабатывает миллиарды записей пользовательских данных и предоставляет бизнес-аналитику
   своим пользователям. 
    - Сервис такси Uber обрабатывает огромные объемы данных о поездках и водителях для анализа
   и оптимизации своих услуг.