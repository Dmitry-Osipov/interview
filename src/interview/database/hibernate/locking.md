# Блокировки в Hibernate
## Оглавление
- [Зачем нужны](#зачем-нужны)
- [Оптимистичные блокировки](#оптимистичные-блокировки)
- [Пессимистичные блокировки](#пессимистичные-блокировки)
- [Обработка исключений при блокировках](#обработка-исключений-при-блокировках)
- [Выбор подходящей блокировки](#выбор-подходящей-блокировки)
- [Дополнительно](#дополнительно)
## Зачем нужны
В Hibernate, как и в других ORM (Object-Relational Mapping) фреймворках, блокировки используются для управления 
параллельным доступом к данным в базе данных. Это важно для обеспечения целостности данных и предотвращения конфликтов 
между транзакциями, которые могут пытаться одновременно читать или изменять одни и те же данные. В Hibernate 
поддерживаются несколько типов блокировок, которые можно разделить на две основные категории: оптимистичные и 
пессимистичные.
## Оптимистичные блокировки
Оптимистичная блокировка предполагает, что конфликты при обновлении данных происходят редко, и не блокирует данные на
уровне базы данных во время выполнения транзакции. Она работает по следующему принципу:
- @Version: В сущности добавляется специальное поле (обычно целочисленное или timestamp), которое автоматически 
обновляется каждый раз при изменении записи. Когда транзакция пытается сохранить изменения в базу данных, Hibernate 
проверяет, что значение этого поля не изменилось с момента последнего чтения данных. Если значение изменилось (т.е.
другая транзакция обновила данные), Hibernate выбрасывает исключение, сигнализирующее о конфликте.
```java
@Entity
public class Product {
    @Id
    private Long id;

    @Version
    private int version;

    private String name;
    // другие поля, геттеры и сеттеры
}
```
Оптимистичная блокировка идеальна для сценариев, где вероятность одновременного изменения данных несколькими 
транзакциями невелика.
## Пессимистичные блокировки
Пессимистичная блокировка используется, когда вероятность конфликта при доступе к данным высока. Она блокирует записи 
в базе данных, чтобы предотвратить одновременное их изменение несколькими транзакциями.

Hibernate поддерживает следующие виды пессимистичных блокировок:
- PESSIMISTIC_READ: Используется для блокировки данных на чтение. Позволяет другим транзакциям читать данные, но не 
обновлять их. Это аналог команды SELECT ... FOR SHARE в SQL. 
- PESSIMISTIC_WRITE: Используется для блокировки данных на запись. Блокирует запись так, что другие транзакции не могут 
ни читать, ни обновлять заблокированные данные, пока не завершится текущая транзакция. Это аналог команды 
SELECT ... FOR UPDATE в SQL. 
- PESSIMISTIC_FORCE_INCREMENT: Это более специфический вид блокировки, который работает аналогично PESSIMISTIC_WRITE,
но дополнительно увеличивает значение поля версии, что помогает при использовании оптимистичной блокировки в комбинации
с пессимистичной.
```java
Product product = entityManager.find(Product.class, productId, LockModeType.PESSIMISTIC_WRITE);
```
## Обработка исключений при блокировках
При использовании блокировок могут возникать различные исключения, которые важно правильно обрабатывать:
- OptimisticLockException: Выбрасывается при конфликте в оптимистичной блокировке.
- PessimisticLockException: Выбрасывается при невозможности установить пессимистичную блокировку.
## Выбор подходящей блокировки
Выбор между оптимистичной и пессимистичной блокировкой зависит от конкретного сценария:
- Оптимистичная блокировка подходит для систем, где конфликты случаются редко и важна производительность.
- Пессимистичная блокировка необходима, когда критична целостность данных, и нужно предотвратить возможные конфликты.
## Дополнительно
- Использование пессимистичных блокировок может негативно влиять на производительность, особенно при большом количестве 
параллельных транзакций.
- Оптимистичная блокировка проще в реализации, но не защищает от всех конфликтов, поэтому её применение следует 
хорошо продумать.
